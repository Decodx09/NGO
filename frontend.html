<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tab-active { 
            border-bottom: 2px solid #4f46e5; 
            color: #4f46e5;
            font-weight: 600;
        }
        .tab { 
            border-bottom: 2px solid transparent; 
            transition: all 0.2s ease-in-out;
        }
        .page { display: none; animation: fadeIn 0.5s; }
        .page-active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .screen { display: none; }

        /* --- Loading Spinner --- */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5; /* indigo-600 */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Skeleton Loader --- */
        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: 0.6; }
        }

        /* --- Mobile Optimization for Tables (User's Original Style) --- */
        @media (max-width: 767px) { /* Tailwind 'md' breakpoint */
            .responsive-table table, 
            .responsive-table thead, 
            .responsive-table tbody, 
            .responsive-table th, 
            .responsive-table td, 
            .responsive-table tr { 
                display: block; 
            }
            .responsive-table thead tr { 
                display: none; /* Hide table headers */
            }
            .responsive-table tr { 
                border: 1px solid #e5e7eb; /* border-gray-200 */
                border-radius: 0.5rem; /* rounded-lg */
                margin-bottom: 1rem; 
                box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
                background-color: #ffffff;
            }
            .responsive-table td { 
                padding: 0.75rem 1.5rem; 
                border-bottom: 1px solid #f3f4f6; /* border-gray-100 */
                position: relative; 
                padding-left: 40%; /* Make space for label */
                text-align: right;
                min-height: 3rem;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            .responsive-table td:last-child {
                border-bottom: 0;
            }
            .responsive-table td:before { 
                content: attr(data-label); /* Get label from data-label attribute */
                position: absolute; 
                left: 1.5rem; 
                width: 35%; /* Label width */
                padding-right: 0.5rem; 
                text-align: left; 
                font-weight: 600;
                color: #1f2937; /* text-gray-800 */
            }
            
            /* --- User's Fix (Preserved) --- */
            .responsive-table td[data-label="Actions"]:before,
            .responsive-table td[data-label="Photos"]:before {
                display: none; 
            }
            .responsive-table td[data-label="Actions"],
            .responsive-table td[data-label="Photos"] {
                padding-left: 1.5rem; 
                justify-content: flex-start;
                text-align: left;
            }
            .responsive-table td[data-label="Actions"] > div,
            .responsive-table td[data-label="Photos"] > div {
                 width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ===== Upgraded Login Screen ===== -->
    <div id="login-screen" class="screen min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Logo -->
            <div class="flex justify-center mb-6">
                <div class="bg-indigo-600 text-white p-3 rounded-full">
                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 21h-2.25m-2.25H5.25A2.25 2.25 0 0 1 3 18.75V5.25A2.25 2.25 0 0 1 5.25 3h13.5A2.25 2.25 0 0 1 21 5.25v13.5A2.25 2.25 0 0 1 18.75 21Z" />
                    </svg>
                </div>
            </div>
            
            <h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Attendance System</h1>
            <p class="text-gray-500 mb-8 text-center">Please select your role to continue</p>
            
            <!-- Card Wrapper -->
            <div class="bg-white p-8 rounded-xl shadow-lg transition-all duration-300">
                <div id="role-selection" class="space-y-4">
                    <button id="show-admin-login-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 12h9.75M10.5 18h9.75M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 6.75h.007v.008H4.125v-.008Zm0 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 6.75h.007v.008H4.125v-.008Zm0 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                        Admin Login
                    </button>
                    <button id="show-teacher-login-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                        Teacher Login
                    </button>
                </div>

                <form id="admin-login-form" class="hidden text-left animate-fadeIn">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Admin Login</h2>
                    <div class="mb-4">
                        <label for="admin-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="admin-username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="admin-password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="space-y-3">
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Login</button>
                        <button type="button" class="back-to-roles-btn w-full bg-gray-200 text-gray-800 py-2 rounded-lg font-medium hover:bg-gray-300 transition">Back</button>
                    </div>
                </form>

                <form id="teacher-login-form" class="hidden text-left animate-fadeIn">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Teacher Login</h2>
                    <div class="mb-4">
                        <label for="employee-code-login" class="block text-sm font-medium text-gray-700 mb-1">Employee Code</label>
                        <input type="text" id="employee-code-login" name="employee_code" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="teacher-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="teacher-password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="space-y-3">
                        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">Login & Proceed</button>
                        <button type="button" class="back-to-roles-btn w-full bg-gray-200 text-gray-800 py-2 rounded-lg font-medium hover:bg-gray-300 transition">Back</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- ===== End Upgraded Login Screen ===== -->

    <!-- ===== Upgraded Admin Screen ===== -->
    <div id="admin-screen" class="screen container mx-auto p-4 md:p-8">
        <header class="mb-8 p-6 bg-white rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                <p class="text-gray-500 mt-1">Teacher Attendance Management</p>
            </div>
            <button id="admin-logout-btn" class="w-full sm:w-auto bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" /></svg>
                Logout
            </button>
        </header>
        
        <nav class="mb-8 bg-white shadow-sm rounded-lg">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500">
                <li class="mr-2"><a href="#" id="tab-dashboard" class="inline-block p-4 tab tab-active rounded-t-lg">Dashboard</a></li>
                <li class="mr-2"><a href="#" id="tab-teachers" class="inline-block p-4 tab rounded-t-lg">Teachers</a></li>
                <li class="mr-2"><a href="#" id="tab-reports" class="inline-block p-4 tab rounded-t-lg">Reports</a></li>
            </ul>
        </nav>

        <main>
            <section id="page-dashboard" class="page page-active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                    <!-- Skeleton Loader for Stats -->
                </div>
            </section>
            <section id="page-teachers" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4 sm:gap-0">
                        <h2 class="text-2xl font-semibold">Teacher Roster</h2>
                        <button id="add-teacher-btn" class="w-full sm:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Add Teacher
                        </button>
                    </div>
                    <div id="teachers-list-container" class="border border-gray-200 rounded-lg overflow-hidden">
                        <div id="teachers-list" class="responsive-table">
                            <!-- Spinner will be injected here -->
                        </div>
                    </div>
                    <div id="attendance-details-section" class="mt-8 hidden">
                        <h3 class="text-xl font-semibold mb-4">Attendance History for <span id="attendance-teacher-name"></span></h3>
                        <div id="attendance-list" class="responsive-table border border-gray-200 rounded-lg overflow-hidden"></div>
                    </div>
                </div>
            </section>
            
            <section id="page-reports" class="page">
                <div class="grid grid-cols-1 gap-12">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-2xl font-semibold mb-4">Present Today</h2>
                            <div id="present-list" class="border border-gray-200 rounded-lg overflow-hidden">
                                <!-- Skeleton loader will be injected here -->
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-2xl font-semibold mb-4">Absent Today</h2>
                            <div id="absent-list" class="border border-gray-200 rounded-lg overflow-hidden">
                                <!-- Skeleton loader will be injected here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-semibold mb-4">Weekly Report</h2>
                        <div id="weekly-report-list" class="border border-gray-200 rounded-lg overflow-hidden responsive-table">
                            <!-- Spinner will be injected here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <!-- ===== End Upgraded Admin Screen ===== -->

    <!-- ===== Upgraded Teacher Screen ===== -->
    <div id="teacher-screen" class="screen min-h-screen flex flex-col p-4">
        <div class="w-full max-w-2xl mx-auto">
             <header class="w-full p-6 bg-white rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-2xl font-bold text-gray-900 text-center sm:text-left" id="teacher-page-title">Live Attendance</h1>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <span id="teacher-greeting" class="text-gray-700 font-medium text-center"></span>
                    <button id="teacher-logout-btn" class="text-sm bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition flex items-center gap-2">
                         <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" /></svg>
                        Logout
                    </button>
                </div>
            </header>
            
            <main id="teacher-main-content" class="bg-white p-6 sm:p-8 rounded-lg shadow-sm border border-gray-200">
                <div id="teacher-loading" class="text-center p-8 text-gray-500">
                    <div class="flex justify-center items-center">
                        <div class="spinner"></div>
                    </div>
                    <p class="mt-4">Loading attendance status...</p>
                </div>

                <!-- Upgraded Status Message -->
                <div id="teacher-status-message" class="hidden p-8 text-center">
                    <h3 class="text-xl font-semibold text-gray-800" id="teacher-status-heading">
                        <!-- Icon and text will be injected by JS -->
                    </h3>
                    <p class="text-gray-600 mt-2" id="teacher-status-details"></p>
                </div>

                <form id="attendance-form" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="photo1" class="block text-sm font-medium text-gray-700 mb-2">Live Photograph 1</label>
                            <input type="file" id="photo1" name="photo1" accept="image/*" capture="environment" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100 cursor-pointer" required>
                            <img id="photo-preview-1" src="" alt="Photo 1 Preview" class="mt-4 rounded-lg hidden w-full border border-gray-200 shadow-sm"/>
                        </div>
                        <div>
                            <label for="photo2" class="block text-sm font-medium text-gray-700 mb-2">Live Photograph 2</label>
                            <input type="file" id="photo2" name="photo2" accept="image/*" capture="environment" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100 cursor-pointer" required>
                            <img id="photo-preview-2" src="" alt="Photo 2 Preview" class="mt-4 rounded-lg hidden w-full border border-gray-200 shadow-sm"/>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" id="submit-attendance-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-400 text-lg">Mark My Attendance</button>
                        <p id="location-status" class="text-sm text-gray-500 mt-4 flex items-center justify-center gap-1.5">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
                            Getting your location...
                        </p>
                    </div>
                </form>
            </main>
        </div>
    </div>
    <!-- ===== End Upgraded Teacher Screen ===== -->

    <!-- ===== Modals and Toast (Unchanged but will look better in context) ===== -->
    <div id="teacher-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-10 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="teacher-modal-title" class="text-2xl font-semibold mb-6">Add New Teacher</h2>
            <form id="add-teacher-form">
                <div class="mb-4"><label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input type="text" id="name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label><input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                <div class="mb-4"><label for="employee_code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code</label><input type="text" id="employee_code" name="employee_code" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="latitude" class="block text-sm font-medium text-gray-700 mb-1">Latitude</label>
                        <input type="number" step="any" id="latitude" name="latitude" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="longitude" class="block text-sm font-medium text-gray-700 mb-1">Longitude</label>
                        <input type="number" step="any" id="longitude" name="longitude" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>

                <div class="mb-6"><label for="teacher-add-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="teacher-add-password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md" required><p class="text-xs text-gray-500 mt-1">Required for new teachers.</p></div>
                <div class="flex flex-col sm:flex-row justify-end gap-4">
                    <button type="button" id="cancel-teacher-btn" class="w-full sm:w-auto px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="save-teacher-btn" class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Teacher</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-20 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>
            </div>
            <h2 class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="cancel-delete-btn" class="w-full sm:w-auto px-6 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="w-full sm:w-auto px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 left-5 sm:left-auto bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300 z-30">
        <p id="toast-message"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // const API_BASE_URL = 'http://100.28.90.244:3000';
            const API_BASE_URL = 'https://jnanaeducation.com';
            // const API_BASE_URL = 'http://localhost:3000';

            // --- Element Selectors ---
            const loginScreen = document.getElementById('login-screen');
            const adminScreen = document.getElementById('admin-screen');
            const teacherScreen = document.getElementById('teacher-screen');
            
            const roleSelection = document.getElementById('role-selection');
            const showAdminLoginBtn = document.getElementById('show-admin-login-btn');
            const showTeacherLoginBtn = document.getElementById('show-teacher-login-btn');
            
            const adminLoginForm = document.getElementById('admin-login-form');
            const teacherLoginForm = document.getElementById('teacher-login-form');
            const backToRolesBtns = document.querySelectorAll('.back-to-roles-btn');
            
            const tabs = document.querySelectorAll('.tab');
            const pages = document.querySelectorAll('.page');
            
            const dashboardStatsEl = document.getElementById('dashboard-stats');
            const teachersListEl = document.getElementById('teachers-list');
            const presentListEl = document.getElementById('present-list');
            const absentListEl = document.getElementById('absent-list');
            const weeklyReportListEl = document.getElementById('weekly-report-list');
            
            const addTeacherBtn = document.getElementById('add-teacher-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const teacherLogoutBtn = document.getElementById('teacher-logout-btn');
            
            // --- Teacher Screen Elements ---
            const teacherGreeting = document.getElementById('teacher-greeting');
            const teacherPageTitle = document.getElementById('teacher-page-title');
            const teacherMainContent = document.getElementById('teacher-main-content');
            const teacherLoading = document.getElementById('teacher-loading');
            const teacherStatusMessage = document.getElementById('teacher-status-message');
            const teacherStatusHeading = document.getElementById('teacher-status-heading');
            const teacherStatusDetails = document.getElementById('teacher-status-details');

            const attendanceForm = document.getElementById('attendance-form');
            const photoInput1 = document.getElementById('photo1');
            const photoPreview1 = document.getElementById('photo-preview-1');
            const photoInput2 = document.getElementById('photo2');
            const photoPreview2 = document.getElementById('photo-preview-2');
            const locationStatusEl = document.getElementById('location-status');
            const submitAttendanceBtn = document.getElementById('submit-attendance-btn');
            
            // --- Teacher Modal ---
            const teacherModal = document.getElementById('teacher-modal');
            const teacherModalTitle = document.getElementById('teacher-modal-title');
            const saveTeacherBtn = document.getElementById('save-teacher-btn');
            const cancelTeacherBtn = document.getElementById('cancel-teacher-btn');
            const addTeacherForm = document.getElementById('add-teacher-form');
            const passwordFieldContainer = document.getElementById('teacher-add-password').parentElement;

            // --- Confirm Modal ---
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            
            // --- Toast ---
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            // --- State Management ---
            let userLocation = null;
            let teacherIdToDelete = null;
            let editModeTeacherId = null;
            let currentTeacherSession = null; 
            let resizedPhoto1 = null;
            let resizedPhoto2 = null;

            // --- UI & Helper Functions ---

            // NEW: Loading spinner and skeleton generators
            const getSpinnerHtml = (message = 'Loading...') => {
                return `<div class="flex flex-col justify-center items-center p-8 text-gray-500">
                            <div class="spinner"></div>
                            <p class="mt-4 text-sm">${message}</p>
                        </div>`;
            };

            const getStatSkeletonHtml = () => {
                return `
                    <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm skeleton"><div class="h-4 bg-gray-200 rounded-md w-1/2"></div><div class="h-8 bg-gray-200 rounded-md w-1/4 mt-2"></div></div>
                    <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm skeleton"><div class="h-4 bg-gray-200 rounded-md w-1/2"></div><div class="h-8 bg-gray-200 rounded-md w-1/4 mt-2"></div></div>
                    <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm skeleton"><div class="h-4 bg-gray-200 rounded-md w-1/2"></div><div class="h-8 bg-gray-200 rounded-md w-1/4 mt-2"></div></div>
                `;
            };
            
            const getListSkeletonHtml = (count = 3) => {
                let html = '';
                for (let i = 0; i < count; i++) {
                    html += `<div class="p-4 border-b last:border-b-0 skeleton">
                                <div class="h-5 bg-gray-200 rounded-md w-3/4"></div>
                                <div class="h-4 bg-gray-200 rounded-md w-1/2 mt-2"></div>
                             </div>`;
                }
                return html;
            };

            const showScreen = (screen) => {
                document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
                const displayStyle = (screen === adminScreen) ? 'block' : 'flex';
                screen.style.display = displayStyle;
            };

            const showToast = (message, isError = false) => {
                toastMessage.textContent = message;
                toast.classList.toggle('bg-red-600', isError);
                toast.classList.toggle('bg-gray-800', !isError);
                toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            };

            const switchTab = (tabId) => {
                tabs.forEach(tab => {
                    const pageId = tab.id.replace('tab-', 'page-');
                    const page = document.getElementById(pageId);
                    if (tab.id === tabId) {
                        tab.classList.add('tab-active');
                        page.classList.add('page-active');
                    } else {
                        tab.classList.remove('tab-active');
                        page.classList.remove('page-active');
                    }
                });
            };

            const showConfirmModal = (teacherId, teacherName) => {
                teacherIdToDelete = teacherId;
                confirmMessage.textContent = `Do you really want to delete ${teacherName}? This will also remove all their attendance records.`;
                confirmModal.classList.remove('hidden');
            };

            const hideConfirmModal = () => {
                teacherIdToDelete = null;
                confirmModal.classList.add('hidden');
            };

            const startLocationCapture = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                            };
                            locationStatusEl.innerHTML = `
                                <svg class="w-4 h-4 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 21h-2.25m-2.25H5.25A2.25 2.25 0 0 1 3 18.75V5.25A2.25 2.25 0 0 1 5.25 3h13.5A2.25 2.25 0 0 1 21 5.25v13.5A2.25 2.25 0 0 1 18.75 21Z" /></svg>
                                Location captured successfully.`;
                            locationStatusEl.classList.replace('text-gray-500', 'text-green-600');
                        },
                        (error) => {
                            userLocation = null;
                            locationStatusEl.innerHTML = `
                                <svg class="w-4 h-4 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>
                                Error: Please enable location services.`;
                            locationStatusEl.classList.replace('text-gray-500', 'text-red-600');
                            showToast('Please enable location services to mark attendance.', true);
                        }
                    );
                } else {
                    locationStatusEl.textContent = 'Geolocation is not supported by this browser.';
                    locationStatusEl.classList.replace('text-gray-500', 'text-red-600');
                }
            };
            
            const resetTeacherModal = () => {
                editModeTeacherId = null;
                teacherModalTitle.textContent = 'Add New Teacher';
                saveTeacherBtn.textContent = 'Save Teacher';
                addTeacherForm.reset();
                passwordFieldContainer.classList.remove('hidden');
                addTeacherForm.elements.password.required = true;
            };

            // User's original, excellent resize function (unchanged)
            function resizeImage(file, maxWidth = 1024, maxHeight = 1024, quality = 0.7) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                            }
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob((blob) => {
                                if (!blob) {
                                    reject(new Error('Canvas to Blob conversion failed.'));
                                    return;
                                }
                                const resizedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now(),
                                });
                                resolve(resizedFile);
                            }, 'image/jpeg', quality);
                        };
                        img.onerror = (error) => reject(error);
                    };
                    reader.onerror = (error) => reject(error);
                });
            }

            // --- API Fetch Functions ---
            const fetchDashboardStats = async () => {
                dashboardStatsEl.innerHTML = getStatSkeletonHtml(); // Use skeleton
                try {
                    const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed to fetch stats');
                    
                    // Upgraded stats cards with icons
                    dashboardStatsEl.innerHTML = `
                        <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm flex items-center gap-4">
                            <div class="flex-shrink-0 bg-indigo-100 text-indigo-600 p-3 rounded-full">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Total Teachers</h3>
                                <p class="text-3xl font-semibold mt-1">${data.total_teachers}</p>
                            </div>
                        </div>
                        <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm flex items-center gap-4">
                             <div class="flex-shrink-0 bg-green-100 text-green-600 p-3 rounded-full">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 21h-2.25m-2.25H5.25A2.25 2.25 0 0 1 3 18.75V5.25A2.25 2.25 0 0 1 5.25 3h13.5A2.25 2.25 0 0 1 21 5.25v13.5A2.25 2.25 0 0 1 18.75 21Z" /></svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-green-600">Present Today</h3>
                                <p class="text-3xl font-semibold mt-1">${data.present_today}</p>
                            </div>
                        </div>
                        <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm flex items-center gap-4">
                             <div class="flex-shrink-0 bg-red-100 text-red-600 p-3 rounded-full">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-red-600">Absent Today</h3>
                                <p class="text-3xl font-semibold mt-1">${data.absent_today}</p>
                            </div>
                        </div>`;
                } catch (error) {
                    dashboardStatsEl.innerHTML = `<p class="text-red-500 col-span-3">${error.message}</p>`;
                }
            };

            const fetchTeachersForAdmin = async () => {
                teachersListEl.innerHTML = getSpinnerHtml('Loading teachers...');
                try {
                    const response = await fetch(`${API_BASE_URL}/teachers`);
                    const teachers = await response.json();
                    if (!response.ok) throw new Error(teachers.error || 'Failed to fetch teachers');
                    
                    if (teachers.length === 0) {
                        teachersListEl.innerHTML = `<div class="p-6 text-center text-gray-500">No teachers found. Add one to get started.</div>`;
                        return;
                    }

                    teachersListEl.innerHTML = `
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Name</th>
                                    <th scope="col" class="px-6 py-3">Email</th>
                                    <th scope="col" class="px-6 py-3">Employee Code</th>
                                    <th scope="col" class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${teachers.map(t => `
                                    <tr class="bg-white border-b hover:bg-gray-50">
                                        <td data-label="Name" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${t.name}</td>
                                        <td data-label="Email" class="px-6 py-4">${t.email}</td>
                                        <td data-label="Code" class="px-6 py-4">${t.employee_code}</td>
                                        <td data-label="Actions" class="px-6 py-4 text-right">
                                            <div class="flex flex-col sm:flex-row sm:justify-end gap-2 sm:gap-0 sm:space-x-4">
                                                <button data-id="${t.id}" data-name="${t.name}" class="view-attendance-btn font-medium text-green-600 hover:underline text-center sm:text-right">View Attendance</button>
                                                <button 
                                                    data-id="${t.id}" 
                                                    data-name="${t.name}" 
                                                    data-email="${t.email}" 
                                                    data-code="${t.employee_code}" 
                                                    data-latitude="${t.latitude || ''}" 
                                                    data-longitude="${t.longitude || ''}" 
                                                    class="edit-btn font-medium text-indigo-600 hover:underline text-center sm:text-right">Edit</button>
                                                <button data-teacher-id="${t.id}" data-teacher-name="${t.name}" class="delete-btn font-medium text-red-600 hover:underline text-center sm:text-right">Delete</button>
                                            </div>
                                        </td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>`;
                } catch (error) {
                    teachersListEl.innerHTML = `<div class="p-6 text-red-500">${error.message}</div>`;
                }
            };
            
            const fetchTodaysAttendance = async () => {
                presentListEl.innerHTML = getListSkeletonHtml(3); // Use skeleton
                try {
                    const response = await fetch(`${API_BASE_URL}/attendance/today`);
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to fetch data');
                    if (result.data.length === 0) {
                        presentListEl.innerHTML = `<div class="p-6 text-center text-gray-500">No attendance marked today.</div>`;
                        return;
                    }

                    presentListEl.innerHTML = result.data.map(r => `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border-b last:border-b-0 gap-2">
                            <div>
                                <p class="font-semibold text-gray-900">${r.teacher_name}</p>
                                <p class="text-xs text-green-600">In: ${new Date(r.check_in_time).toLocaleTimeString()}</p>
                                ${r.check_out_time ? `<p class="text-xs text-red-600">Out: ${new Date(r.check_out_time).toLocaleTimeString()}</p>` : '<p class="text-xs text-gray-500">Out: Not marked</p>'}
                            </div>
                            <div class="flex flex-col text-right gap-1">
                                <div class="flex gap-2 justify-end">
                                    <span class="text-xs text-gray-500">In:</span>
                                    <a href="${API_BASE_URL}${r.check_in_photo_url1}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 1</a> 
                                    <a href="${API_BASE_URL}${r.check_in_photo_url2}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 2</a>
                                </div>
                                ${r.check_out_photo_url1 ? `
                                <div class="flex gap-2 justify-end">
                                    <span class="text-xs text-gray-500">Out:</span>
                                    <a href="${API_BASE_URL}${r.check_out_photo_url1}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 1</a> 
                                    <a href="${API_BASE_URL}${r.check_out_photo_url2}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 2</a>
                                </div>` : ''}
                            </div>
                        </div>`).join('');
                } catch (error) {
                    presentListEl.innerHTML = `<div class="p-6 text-red-500">${error.message}</div>`;
                }
            };

            const fetchAbsentTeachers = async () => {
                absentListEl.innerHTML = getListSkeletonHtml(3); // Use skeleton
                try {
                    const response = await fetch(`${API_BASE_URL}/attendance/absent`);
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to fetch data');
                    if (result.data.length === 0) {
                        absentListEl.innerHTML = `<div class="p-6 text-center text-gray-500">All teachers have checked in today.</div>`;
                        return;
                    }
                    absentListEl.innerHTML = result.data.map(t => `<div class="p-4 border-b last:border-b-0"><p class="font-semibold text-gray-900">${t.name}</p><p class="text-xs text-gray-500">${t.email}</p></div>`).join('');
                } catch (error) {
                    absentListEl.innerHTML = `<div class"p-6 text-red-500">${error.message}</div>`;
                }
            };
            
            const fetchWeeklyReport = async () => {
                weeklyReportListEl.innerHTML = getSpinnerHtml('Loading weekly report...'); // Use spinner
                try {
                    const response = await fetch(`${API_BASE_URL}/attendance/report/weekly`);
                    const rawText = await response.text();
                    
                    let result;
                    try {
                        result = JSON.parse(rawText);
                    } catch (e) {
                        throw new Error(`Server returned an invalid response (expected JSON): <br><pre class="whitespace-pre-wrap text-left p-4 bg-gray-100 rounded-md">${rawText.length > 500 ? rawText.substring(0, 500) + '...' : rawText}</pre>`);
                    }
                    
                    if (!response.ok) {
                         throw new Error(result.error || 'Failed to fetch weekly report');
                    }
                    
                    if (result.data.length === 0) {
                        weeklyReportListEl.innerHTML = `<div class="p-6 text-center text-gray-500">No attendance records found in the last 7 days.</div>`;
                        return;
                    }

                    weeklyReportListEl.innerHTML = `
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Teacher</th>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Check-in</th>
                                    <th scope="col" class="px-6 py-3">Check-out</th>
                                    <th scope="col" class="px-6 py-3">Photos</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(r => `
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td data-label="Teacher" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${r.name} <span class="block text-xs font-normal text-gray-500 sm:hidden">(${r.employee_code})</span></td>
                                    <td data-label="Date" class="px-6 py-4">${new Date(r.check_in_time).toLocaleDateString()}</td>
                                    <td data-label="Check-in" class="px-6 py-4 text-green-600">${new Date(r.check_in_time).toLocaleTimeString()}</td>
                                    <td data-label="Check-out" class="px-6 py-4 ${r.check_out_time ? 'text-red-600' : 'text-gray-400'}">${r.check_out_time ? new Date(r.check_out_time).toLocaleTimeString() : 'N/A'}</td>
                                    <td data-label="Photos" class="px-6 py-4">
                                        <div class="flex flex-col gap-1">
                                            <div class="flex gap-2 items-center">
                                                <span class="text-xs text-gray-500 w-8">In:</span>
                                                <a href="${API_BASE_URL}${r.check_in_photo_url1}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 1</a> 
                                                <a href="${API_BASE_URL}${r.check_in_photo_url2}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 2</a>
                                            </div>
                                            ${r.check_out_photo_url1 ? `
                                            <div class="flex gap-2 items-center">
                                                <span class="text-xs text-gray-500 w-8">Out:</span>
                                                <a href="${API_BASE_URL}${r.check_out_photo_url1}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 1</a> 
                                                <a href="${API_BASE_URL}${r.check_out_photo_url2}" target="_blank" class="text-sm text-indigo-600 hover:underline">Photo 2</a>
                                            </div>` : ''}
                                        </div>
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>`;
                } catch (error) {
                    weeklyReportListEl.innerHTML = `<div class="p-6 text-red-500">${error.message}</div>`;
                }
            };

            const deleteTeacher = async (teacherId) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/teachers/${teacherId}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to delete teacher');
                    showToast('Teacher deleted successfully!');
                    hideConfirmModal();
                    initializeAdminDashboard();
                } catch (error) {
                    showToast(error.message, true);
                    hideConfirmModal();
                }
            };

            const fetchAndDisplayTeacherAttendance = async (teacherId, teacherName) => {
                const attendanceDetailsSection = document.getElementById('attendance-details-section');
                const attendanceListEl = document.getElementById('attendance-list');
                const attendanceTeacherNameEl = document.getElementById('attendance-teacher-name');

                attendanceListEl.innerHTML = getSpinnerHtml('Loading attendance...'); // Use spinner
                attendanceTeacherNameEl.textContent = teacherName;
                attendanceDetailsSection.classList.remove('hidden');

                try {
                    const response = await fetch(`${API_BASE_URL}/attendance/report/teacher/${teacherId}?startDate=2000-01-01&endDate=2100-01-01`);
                    const result = await response.json();

                    if (!response.ok) {
                         throw new Error(result.error || 'Failed to fetch attendance');
                    }
                    
                    if (result.data.length === 0) {
                        attendanceListEl.innerHTML = `<div class="p-6 text-center text-gray-500">No attendance records found for this teacher.</div>`;
                        return;
                    }

                    attendanceListEl.innerHTML = `
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Check-in</th>
                                    <th scope="col" class="px-6 py-3">Check-out</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(a => `
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td data-label="Date" class="px-6 py-4">${new Date(a.check_in_time).toLocaleDateString()}</td>
                                    <td data-label="Check-in" class="px-6 py-4">${new Date(a.check_in_time).toLocaleTimeString()}</td>
                                    <td data-label="Check-out" class="px-6 py-4">${a.check_out_time ? new Date(a.check_out_time).toLocaleTimeString() : 'N/A'}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>`;
                } catch (error) {
                    attendanceListEl.innerHTML = `<div class="p-6 text-red-500">${error.message}</div>`;
                }
            };

            const fetchTeacherAttendanceStatus = async (teacherId) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/attendance/status/${teacherId}`);
                    
                    if (!response.ok) {
                        let errorMsg = `Error: ${response.status} ${response.statusText}`;
                        try {
                            const errData = await response.json();
                            errorMsg = errData.error || 'Failed to fetch status.';
                        } catch (e) {
                             errorMsg = 'Server returned an invalid response. Please check the backend.';
                        }
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    currentTeacherSession = result;
                    updateTeacherUI(result);

                } catch (error) {
                    console.error('Error fetching teacher status:', error);
                    teacherLoading.classList.add('hidden');
                    teacherStatusMessage.classList.remove('hidden');
                    teacherStatusHeading.textContent = 'Error';
                    teacherStatusHeading.classList.add('text-red-500');
                    teacherStatusDetails.textContent = error.message;
                }
            };

            // NEW: Resets the teacher status UI
            const resetTeacherStatusUI = () => {
                teacherStatusMessage.classList.remove('bg-green-50', 'border-green-200', 'bg-blue-50', 'border-blue-200', 'border', 'p-6', 'rounded-lg', 'flex', 'items-center', 'gap-4');
                teacherStatusHeading.classList.remove('text-green-800', 'text-blue-800', 'text-red-500');
                teacherStatusDetails.classList.remove('text-green-700', 'text-blue-700');
                teacherStatusHeading.innerHTML = ''; // Clear icon
                teacherStatusDetails.innerHTML = '';
            }

            // UPDATED: Teacher UI function with new styles
            const updateTeacherUI = (status) => {
                teacherLoading.classList.add('hidden');
                resetTeacherStatusUI(); // Reset styles first

                if (status.status === 'not_checked_in') { 
                    teacherPageTitle.textContent = 'Mark Check-In';
                    teacherStatusMessage.classList.add('hidden');
                    attendanceForm.classList.remove('hidden');
                    submitAttendanceBtn.textContent = 'Submit Check-In';
                    submitAttendanceBtn.classList.replace('bg-blue-600', 'bg-green-600');
                    submitAttendanceBtn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                } else if (status.status === 'checked_in') { 
                    teacherPageTitle.textContent = 'Mark Check-Out';
                    teacherStatusMessage.classList.remove('hidden');
                    attendanceForm.classList.remove('hidden');
                    
                    // Add new styles for "checked in"
                    teacherStatusMessage.classList.add('bg-green-50', 'border', 'border-green-200', 'p-6', 'rounded-lg', 'flex', 'flex-col', 'sm:flex-row', 'items-center', 'gap-4');
                    teacherStatusHeading.innerHTML = `
                        <svg class="w-8 h-8 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>
                        <span class="text-xl font-semibold text-green-800">You are checked in!</span>`;
                    
                    const checkInTime = status.check_in_time;
                    teacherStatusDetails.textContent = `Checked in at: ${new Date(checkInTime).toLocaleTimeString()}`;
                    teacherStatusDetails.classList.add('text-green-700', 'mt-1', 'sm:mt-0', 'sm:ml-auto');
                    
                    submitAttendanceBtn.textContent = 'Submit Check-Out';
                    submitAttendanceBtn.classList.replace('bg-green-600', 'bg-blue-600');
                    submitAttendanceBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                } else if (status.status === 'completed') {
                    teacherPageTitle.textContent = 'Attendance Complete';
                    attendanceForm.classList.add('hidden');
                    teacherStatusMessage.classList.remove('hidden');
                    
                    // Add new styles for "completed"
                    teacherStatusMessage.classList.add('bg-blue-50', 'border', 'border-blue-200', 'p-6', 'rounded-lg', 'flex', 'flex-col', 'sm:flex-row', 'items-center', 'gap-4');
                    teacherStatusHeading.innerHTML = `
                        <svg class="w-8 h-8 text-blue-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        <span class="text-xl font-semibold text-blue-800">Session Complete!</span>`;
                    
                    const checkOutTime = status.check_out_time;
                    teacherStatusDetails.textContent = `You checked out at: ${new Date(checkOutTime).toLocaleTimeString()}`;
                    teacherStatusDetails.classList.add('text-blue-700', 'mt-1', 'sm:mt-0', 'sm:ml-auto');
                } else {
                    console.error("Unknown attendance status received:", status);
                    teacherPageTitle.textContent = 'Live Attendance';
                    attendanceForm.classList.add('hidden');
                    teacherStatusMessage.classList.remove('hidden');
                    teacherStatusHeading.textContent = 'Unable to load status';
                    teacherStatusHeading.classList.add('text-red-500');
                    teacherStatusDetails.textContent = 'Could not determine your attendance status. Please try logging out and back in.';
                }
            };


            // --- Event Listeners Setup ---
            showAdminLoginBtn.addEventListener('click', () => {
                roleSelection.classList.add('hidden');
                adminLoginForm.classList.remove('hidden');
            });
            
            showTeacherLoginBtn.addEventListener('click', () => {
                roleSelection.classList.add('hidden');
                teacherLoginForm.classList.remove('hidden');
            });

            backToRolesBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    adminLoginForm.classList.add('hidden');
                    teacherLoginForm.classList.add('hidden');
                    roleSelection.classList.remove('hidden');
                });
            });

            adminLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(adminLoginForm);
                const data = Object.fromEntries(formData.entries());
                try {
                    const response = await fetch(`${API_BASE_URL}/login/admin`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Login failed');
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    showScreen(adminScreen);
                    initializeAdminDashboard();
                } catch (error) {
                    showToast(error.message, true);
                }
            });

            teacherLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(teacherLoginForm);
                const data = Object.fromEntries(formData.entries());
                try {
                    const response = await fetch(`${API_BASE_URL}/login/teacher`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Login failed');
                    sessionStorage.setItem('loggedInTeacher', JSON.stringify(result.teacher));
                    setupAuthenticatedTeacherView(result.teacher);
                } catch (error) {
                    showToast(error.message, true);
                }
            });

            adminLogoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('isAdminLoggedIn');
                showScreen(loginScreen);
                adminLoginForm.reset();
                teacherLoginForm.reset();
                adminLoginForm.classList.add('hidden');
                teacherLoginForm.classList.add('hidden');
                roleSelection.classList.remove('hidden');
            });

            teacherLogoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('loggedInTeacher');
                attendanceForm.reset();
                photoPreview1.classList.add('hidden');
                photoPreview2.classList.add('hidden');
                showScreen(loginScreen);
                adminLoginForm.reset();
                teacherLoginForm.reset();
                adminLoginForm.classList.add('hidden');
                teacherLoginForm.classList.add('hidden');
                roleSelection.classList.remove('hidden');
            });

            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(tab.id);
                });
            });

            addTeacherBtn.addEventListener('click', () => {
                resetTeacherModal();
                teacherModal.classList.remove('hidden');
            });

            cancelTeacherBtn.addEventListener('click', () => {
                teacherModal.classList.add('hidden');
                resetTeacherModal();
            });

            teachersListEl.addEventListener('click', (e) => {
                const target = e.target;
                if (target.classList.contains('delete-btn')) {
                    showConfirmModal(target.dataset.teacherId, target.dataset.teacherName);
                } else if (target.classList.contains('edit-btn')) {
                    editModeTeacherId = target.dataset.id;
                    addTeacherForm.elements.name.value = target.dataset.name;
                    addTeacherForm.elements.email.value = target.dataset.email;
                    addTeacherForm.elements.employee_code.value = target.dataset.code;
                    addTeacherForm.elements.latitude.value = target.dataset.latitude;
                    addTeacherForm.elements.longitude.value = target.dataset.longitude;
                    teacherModalTitle.textContent = 'Edit Teacher Details';
                    saveTeacherBtn.textContent = 'Save Changes';
                    passwordFieldContainer.classList.add('hidden'); 
                    addTeacherForm.elements.password.required = false;
                    teacherModal.classList.remove('hidden');
                } else if (target.classList.contains('view-attendance-btn')) {
                    const teacherId = target.dataset.id;
                    const teacherName = target.dataset.name;
                    fetchAndDisplayTeacherAttendance(teacherId, teacherName);
                }
            });

            cancelDeleteBtn.addEventListener('click', hideConfirmModal);
            confirmDeleteBtn.addEventListener('click', () => {
                if (teacherIdToDelete) {
                    deleteTeacher(teacherIdToDelete);
                }
            });

            addTeacherForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(addTeacherForm);
                const data = Object.fromEntries(formData.entries());
                
                const isEditMode = !!editModeTeacherId;
                if (isEditMode && !data.password) {
                    delete data.password;
                }

                const url = isEditMode ? `${API_BASE_URL}/teachers/${editModeTeacherId}` : `${API_BASE_URL}/teachers`;
                const method = isEditMode ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to save teacher');
                    
                    showToast(`Teacher ${isEditMode ? 'updated' : 'added'} successfully!`);
                    teacherModal.classList.add('hidden');
                    resetTeacherModal();
                    fetchTeachersForAdmin();
                } catch (error) {
                    showToast(error.message, true);
                }
            });

            attendanceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const loggedInTeacher = JSON.parse(sessionStorage.getItem('loggedInTeacher'));
                if (!loggedInTeacher) {
                    showToast('Authentication error. Please log in again.', true); return;
                }
                if (!userLocation) {
                    showToast('Location not available. Please enable location services.', true); return;
                }
                
                if (!resizedPhoto1 || !resizedPhoto2) {
                    showToast('Please select and wait for both photos to process.', true);
                    return;
                }
                
                const formData = new FormData();
                formData.append('latitude', userLocation.latitude);
                formData.append('longitude', userLocation.longitude);
                formData.append('teacher_id', loggedInTeacher.id);
                formData.append('photo1', resizedPhoto1, 'photo1.jpg');
                formData.append('photo2', resizedPhoto2, 'photo2.jpg');
                
                submitAttendanceBtn.disabled = true;
                submitAttendanceBtn.textContent = 'Submitting...';

                try {
                    const response = await fetch(`${API_BASE_URL}/attendance`, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to mark attendance');
                    
                    showToast('Attendance marked successfully!');
                    fetchTeacherAttendanceStatus(loggedInTeacher.id);

                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    attendanceForm.reset();
                    photoPreview1.classList.add('hidden');
                    photoPreview2.classList.add('hidden');
                    photoPreview1.src = '';
                    photoPreview2.src = '';
                    resizedPhoto1 = null;
                    resizedPhoto2 = null;
                    submitAttendanceBtn.disabled = false;
                }
            });

            // UPDATED: Photo handler with better user feedback
            async function handlePhotoInput(e, previewEl, storageKey) {
                const file = e.target.files[0];
                if (!file) return;

                previewEl.src = "";
                previewEl.classList.add('hidden');
                if (storageKey === 'photo1') resizedPhoto1 = null;
                if (storageKey === 'photo2') resizedPhoto2 = null;

                showToast('Processing image... Please wait.', false);

                try {
                    const resizedFile = await resizeImage(file, 1024, 1024, 0.7);

                    if (storageKey === 'photo1') {
                        resizedPhoto1 = resizedFile;
                    } else if (storageKey === 'photo2') {
                        resizedPhoto2 = resizedFile;
                    }

                    const previewUrl = URL.createObjectURL(resizedFile);
                    previewEl.src = previewUrl;
                    previewEl.classList.remove('hidden');
                    
                    showToast(`Image processed (Size: ${(resizedFile.size / 1024).toFixed(0)} KB)`, false);

                } catch (error) {
                    console.error('Image resize error:', error);
                    showToast('Error processing image. Please try another.', true);
                    e.target.value = null; 
                }
            }

            photoInput1.addEventListener('change', (e) => handlePhotoInput(e, photoPreview1, 'photo1'));
            photoInput2.addEventListener('change', (e) => handlePhotoInput(e, photoPreview2, 'photo2'));
            
            // --- App Initialization ---
            const initializeAdminDashboard = () => {
                fetchDashboardStats();
                fetchTeachersForAdmin();
                fetchTodaysAttendance();
                fetchAbsentTeachers();
                fetchWeeklyReport();
            };

            const setupAuthenticatedTeacherView = (teacher) => {
                teacherGreeting.textContent = `Welcome, ${teacher.name}`;
                showScreen(teacherScreen);
                startLocationCapture();
                
                teacherLoading.classList.remove('hidden');
                attendanceForm.classList.add('hidden');
                teacherStatusMessage.classList.add('hidden');

                fetchTeacherAttendanceStatus(teacher.id);
            };

            const main = () => {
                const isAdmin = sessionStorage.getItem('isAdminLoggedIn') === 'true';
                const loggedInTeacherData = sessionStorage.getItem('loggedInTeacher');

                if (isAdmin) {
                    showScreen(adminScreen);
                    initializeAdminDashboard();
                } else if (loggedInTeacherData) {
                    setupAuthenticatedTeacherView(JSON.parse(loggedInTeacherData));
                } else {
                    showScreen(loginScreen);
                }
            };

            main();
        });
    </script>
</body>
</html>
